---
variables:
  IMAGE_NAME: grpc-cpp
  PYTHON: /home/romain/perso/fly/grpc-cpp/venv/bin/python

logs:
  script:
    - fly logs


build:
  script:
    - docker build . --tag $IMAGE_NAME

shell:
  script:
    - docker run -it --rm $IMAGE_NAME

deploy:
  script:
    - fly deploy

display_variables:
  script:
    - ncdump -c server/data/era5_Tmax_40.0_0.0_projection_2030.nc

h:
  script:
    - ncdump -h server/data/era5_Tmax_40.0_0.0_projection_2030.nc


address:
  cwd: ./proto
  script:
    >
      grpcurl -d '{"name": "aaa"}'
      -proto myproto/addressbook.proto
      -plaintext localhost:50051
      expcmake.AddressBook/GetAddress

t:
  cwd: ./proto
  script:
    >
      grpcurl -d '{"days_since_start": 0, "latitude": 40.0, "longitude": 9.9}'
      -proto myproto/tmax.proto
      -plaintext localhost:50051
      netcdf.Tmax/GetValue

to:
  cwd: ./proto
  script:
    >
      grpcurl -d '{"days_since_start": 0, "latitude": 40.45, "longitude": 8.7}'
      -proto myproto/tmax.proto
      grpc-climate.fly.dev:443
      netcdf.Tmax/GetValue


generate_python_proto:
  script:
    >
      $PYTHON -m grpc_tools.protoc
      --proto_path=proto/myproto
      --python_out=.
      --grpc_python_out=.
      ./proto/myproto/tmax.proto

