---
variables:
  IMAGE_NAME: grpc-climate
  PYTHON: $PWD/venv/bin/python

build:
  cwd: ./build
  script:
    - make

build-client:
  script:
    >
      $PYTHON -m grpc_tools.protoc
      -Iproto/myproto
      --python_out=python_client
      --pyi_out=python_client
      --grpc_python_out=python_client
      proto/myproto/tmax.proto

run-client:
  script:
    >
      $PYTHON python_client/client.py

run:
  script:
    - ./build/server/server

test:
  cwd: ./build/server
  script:
    - ./test_netcdf_tools

logs:
  script:
    - fly logs

docker-build:
  script:
    - docker build . --tag $IMAGE_NAME

docker-shell:
  script:
    - docker run -it --rm $IMAGE_NAME

docker-run:
  script:
    docker run --name $IMAGE_NAME --rm -d -p 50051:50051 $IMAGE_NAME

deploy:
  script:
    - fly deploy

display_variables:
  script:
    - ncdump -c server/data/era5_Tmax_40.0_0.0_projection_2030.nc

h:
  script:
    - ncdump -h server/data/era5_Tmax_40.0_0.0_projection_2030.nc

notebook:
  script:
    - $PYTHON -m jupyter notebook

address:
  cwd: ./proto
  script:
    >
      grpcurl -d '{"name": "aaa"}'
      -proto myproto/addressbook.proto
      -plaintext localhost:50051
      expcmake.AddressBook/GetAddress

t:
  cwd: ./proto
  script:
    >
      grpcurl -d '{"days_since_start": 0, "latitude": 40.0, "longitude": 9.9}'
      -proto myproto/tmax.proto
      -plaintext localhost:50051
      climate.Tmax/GetValue

s:
  cwd: ./proto
  script:
    >
      grpcurl -d '{"latitude": 40.0, "longitude": 9.9}'
      -proto myproto/tmax.proto
      -plaintext localhost:50051
      climate.Tmax/GetTemperatures

to:
  cwd: ./proto
  script:
    >
      grpcurl -d '{"days_since_start": 0, "latitude": 40.45, "longitude": 8.7}'
      -proto myproto/tmax.proto
      grpc-climate.fly.dev:443
      climate.Tmax/GetTemperatures

tmsi:
  cwd: ./proto
  script:
    >
      grpcurl -d '{"days_since_start": 0, "latitude": 40.45, "longitude": 8.7}'
      -proto myproto/tmax.proto
      -plaintext 192.168.1.236:50051
      climate.Tmax/GetValue

generate_python_proto:
  script:
    >
      $PYTHON -m grpc_tools.protoc
      --proto_path=proto/myproto
      --python_out=.
      --grpc_python_out=.
      ./proto/myproto/tmax.proto
